===
Build
===

#!/usr/bin/env dang

let src = host.directory(
  "."
  include: [
    "**/*.go"
    "**/go.mod"
    "**/go.sum"
    "introspection/introspection.graphql"
  ]
)

let bin(src: Directory!): File! {
  container.
    from("golang").
    withDirectory("/src", src).
    withWorkdir("/src").
    withEnvVariable("CGO_ENABLED", "0").
    withExec(["go", "build", "-o", "/out/dang", "./cmd/dang"]).
    file("/out/dang")
}

let test(bin: File!): String! {
  container.
    from("alpine").
    withFile("/bin/dang", bin).
    withExec(["dang", "--version"]).
    stdout
}

print(test(bin(src)))

---

(dang
  (comment_token)
  (decl
    (slot
      (value_only_slot
        (visibility
          (let_token))
        (symbol
          (id
            (word_token)))
        (equal_token)
        (select_or_call
          (symbol_or_call
            (auto_call_symbol
              (id
                (word_token))))
          (dot_token)
          (field_id)
          (arg_values
            (immediate_paren)
            (argument
              (positional_value
                (literal
                  (string
                    (immediate_string_content)
                    (immediate_quote_token)))))
            (sep)
            (argument
              (key_value
                (word_token)
                (colon_token)
                (list
                  (literal
                    (string
                      (immediate_string_content)
                      (immediate_quote_token)))
                  (sep)
                  (literal
                    (string
                      (immediate_string_content)
                      (immediate_quote_token)))
                  (sep)
                  (literal
                    (string
                      (immediate_string_content)
                      (immediate_quote_token)))
                  (sep)
                  (literal
                    (string
                      (immediate_string_content)
                      (immediate_quote_token)))
                  (sep))))
            (sep))))))
  (sep)
  (decl
    (slot
      (type_and_args_and_block_slot
        (visibility
          (let_token))
        (symbol
          (id
            (word_token)))
        (arg_types
          (immediate_paren)
          (arg_type
            (arg_with_type
              (symbol
                (id
                  (word_token)))
              (colon_token)
              (type
                (non_null
                  (type
                    (named_type
                      (upper_id
                        (upper_token))))
                  (bang_token))))))
        (colon_token)
        (type
          (non_null
            (type
              (named_type
                (upper_id
                  (upper_token))))
            (bang_token)))
        (block
          (select_or_call
            (select_or_call
              (select_or_call
                (select_or_call
                  (select_or_call
                    (select_or_call
                      (symbol_or_call
                        (auto_call_symbol
                          (id
                            (word_token))))
                      (dot_token)
                      (field_id)
                      (arg_values
                        (immediate_paren)
                        (argument
                          (positional_value
                            (literal
                              (string
                                (immediate_string_content)
                                (immediate_quote_token)))))))
                    (dot_token)
                    (field_id)
                    (arg_values
                      (immediate_paren)
                      (argument
                        (positional_value
                          (literal
                            (string
                              (immediate_string_content)
                              (immediate_quote_token)))))
                      (sep
                        (comma_token))
                      (argument
                        (positional_value
                          (symbol_or_call
                            (auto_call_symbol
                              (id
                                (word_token))))))))
                  (dot_token)
                  (field_id)
                  (arg_values
                    (immediate_paren)
                    (argument
                      (positional_value
                        (literal
                          (string
                            (immediate_string_content)
                            (immediate_quote_token)))))))
                (dot_token)
                (field_id)
                (arg_values
                  (immediate_paren)
                  (argument
                    (positional_value
                      (literal
                        (string
                          (immediate_string_content)
                          (immediate_quote_token)))))
                  (sep
                    (comma_token))
                  (argument
                    (positional_value
                      (literal
                        (string
                          (immediate_string_content)
                          (immediate_quote_token)))))))
              (dot_token)
              (field_id)
              (arg_values
                (immediate_paren)
                (argument
                  (positional_value
                    (list
                      (literal
                        (string
                          (immediate_string_content)
                          (immediate_quote_token)))
                      (sep
                        (comma_token))
                      (literal
                        (string
                          (immediate_string_content)
                          (immediate_quote_token)))
                      (sep
                        (comma_token))
                      (literal
                        (string
                          (immediate_string_content)
                          (immediate_quote_token)))
                      (sep
                        (comma_token))
                      (literal
                        (string
                          (immediate_string_content)
                          (immediate_quote_token)))
                      (sep
                        (comma_token))
                      (literal
                        (string
                          (immediate_string_content)
                          (immediate_quote_token))))))))
            (dot_token)
            (field_id)
            (arg_values
              (immediate_paren)
              (argument
                (positional_value
                  (literal
                    (string
                      (immediate_string_content)
                      (immediate_quote_token)))))))
          (sep)))))
  (sep)
  (decl
    (slot
      (type_and_args_and_block_slot
        (visibility
          (let_token))
        (symbol
          (id
            (word_token)))
        (arg_types
          (immediate_paren)
          (arg_type
            (arg_with_type
              (symbol
                (id
                  (word_token)))
              (colon_token)
              (type
                (non_null
                  (type
                    (named_type
                      (upper_id
                        (upper_token))))
                  (bang_token))))))
        (colon_token)
        (type
          (non_null
            (type
              (named_type
                (upper_id
                  (upper_token))))
            (bang_token)))
        (block
          (select_or_call
            (select_or_call
              (select_or_call
                (select_or_call
                  (symbol_or_call
                    (auto_call_symbol
                      (id
                        (word_token))))
                  (dot_token)
                  (field_id)
                  (arg_values
                    (immediate_paren)
                    (argument
                      (positional_value
                        (literal
                          (string
                            (immediate_string_content)
                            (immediate_quote_token)))))))
                (dot_token)
                (field_id)
                (arg_values
                  (immediate_paren)
                  (argument
                    (positional_value
                      (literal
                        (string
                          (immediate_string_content)
                          (immediate_quote_token)))))
                  (sep
                    (comma_token))
                  (argument
                    (positional_value
                      (symbol_or_call
                        (auto_call_symbol
                          (id
                            (word_token))))))))
              (dot_token)
              (field_id)
              (arg_values
                (immediate_paren)
                (argument
                  (positional_value
                    (list
                      (literal
                        (string
                          (immediate_string_content)
                          (immediate_quote_token)))
                      (sep
                        (comma_token))
                      (literal
                        (string
                          (immediate_string_content)
                          (immediate_quote_token))))))))
            (dot_token)
            (field_id))
          (sep)))))
  (sep)
  (symbol_or_call
    (call
      (symbol
        (id
          (word_token)))
      (arg_values
        (immediate_paren)
        (argument
          (positional_value
            (symbol_or_call
              (call
                (symbol
                  (id
                    (word_token)))
                (arg_values
                  (immediate_paren)
                  (argument
                    (positional_value
                      (symbol_or_call
                        (call
                          (symbol
                            (id
                              (word_token)))
                          (arg_values
                            (immediate_paren)
                            (argument
                              (positional_value
                                (symbol_or_call
                                  (auto_call_symbol
                                    (id
                                      (word_token))))))))))))))))))))
