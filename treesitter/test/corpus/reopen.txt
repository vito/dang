===
Reopening
===

pub description =
  "Builds containers from simple lists of packages using the Apko CLI."

# TODO
pvt arch = "linux/amd64"

cls Apko {
  pub config = {{
    contents: {{
      packages: []
      repositories: []
      keyring: []
      cmd: ""
      environment: {{
        PATH: "/usr/local/bin:/usr/bin:/bin"
      }}
      archs: [arch]
    }}
  }}

  pub withAlpine(branch: String! = "edge"): Apko! {
    self << {
      config << {
        packages += ["apk-tools"]
        repositories += [("https://dl-cdn.alpinelinux.org/alpine/" + branch) + "/main"]
      }
    }
  }

  pub withPackages(packages: [String!]!): Apko! {
    pvt outer = here
    self << { config << { packages += outer.packages } }
  }

  pub withArchs(archs: [String!]!): Apko! {
    pvt outer = here
    self << { config << { archs += outer.archs } }
  }

  pub asContainer: Container! {
    container.import(
      container.
        from("cgr.dev/chainguard/apko").
        withMountedCache("/apkache/", cacheVolume("apko")).
        withExec(["apko", "build", "--cache-dir", "/apkache/", json(config), "layout.tar"]).
        file("layout.tar")
    )
  }

  pub alpine(packages: [String!]!, branch: String! = "edge"): Container! {
    self.withAlpine(branch).withPackages(packaegs).asContainer
  }
}

---

(dash
  (slot
    (value_only_slot
      (visibility
        (pub_token))
      (id
        (word_token))
      (literal
        (string))))
  (sep)
  (comment_token)
  (slot
    (value_only_slot
      (visibility
        (pvt_token))
      (id
        (word_token))
      (literal
        (string))))
  (sep)
  (class
    (cls_token)
    (id
      (word_token))
    (block
      (slot
        (value_only_slot
          (visibility
            (pub_token))
          (id
            (word_token))
          (object
            (key_value
              (word_token)
              (colon_token)
              (object
                (key_value
                  (word_token)
                  (colon_token)
                  (list))
                (sep)
                (key_value
                  (word_token)
                  (colon_token)
                  (list))
                (sep)
                (key_value
                  (word_token)
                  (colon_token)
                  (list))
                (sep)
                (key_value
                  (word_token)
                  (colon_token)
                  (literal
                    (string)))
                (sep)
                (key_value
                  (word_token)
                  (colon_token)
                  (object
                    (key_value
                      (word_token)
                      (colon_token)
                      (literal
                        (string)))
                    (sep)))
                (sep)
                (key_value
                  (word_token)
                  (colon_token)
                  (list
                    (symbol_or_call
                      (symbol
                        (id
                          (word_token))))))
                (sep)))
            (sep))))
      (sep)
      (slot
        (type_and_args_and_block_slot
          (visibility
            (pub_token))
          (id
            (word_token))
          (arg_types
            (arg_type
              (arg_with_default
                (id
                  (word_token))
                (colon_token)
                (type
                  (non_null
                    (type
                      (named_type
                        (upper_id
                          (upper_token))))
                    (bang_token)))
                (literal
                  (string)))))
          (colon_token)
          (type
            (non_null
              (type
                (named_type
                  (upper_id
                    (upper_token))))
              (bang_token)))
          (block
            (reopen
              (id
                (word_token))
              (reopen_token)
              (block
                (reopen
                  (id
                    (word_token))
                  (reopen_token)
                  (block
                    (compound_assignment
                      (id
                        (word_token))
                      (compound_op
                        (plus_equal_token))
                      (list
                        (literal
                          (string))))
                    (sep)
                    (compound_assignment
                      (id
                        (word_token))
                      (compound_op
                        (plus_equal_token))
                      (list
                        (infix
                          (addition
                            (paren_form
                              (infix
                                (addition
                                  (literal
                                    (string))
                                  (plus_token)
                                  (symbol_or_call
                                    (symbol
                                      (id
                                        (word_token)))))))
                            (plus_token)
                            (literal
                              (string))))))
                    (sep)))
                (sep)))
            (sep))))
      (sep)
      (slot
        (type_and_args_and_block_slot
          (visibility
            (pub_token))
          (id
            (word_token))
          (arg_types
            (arg_type
              (arg_with_type
                (id
                  (word_token))
                (colon_token)
                (type
                  (non_null
                    (type
                      (list_type
                        (type
                          (non_null
                            (type
                              (named_type
                                (upper_id
                                  (upper_token))))
                            (bang_token)))))
                    (bang_token))))))
          (colon_token)
          (type
            (non_null
              (type
                (named_type
                  (upper_id
                    (upper_token))))
              (bang_token)))
          (block
            (slot
              (value_only_slot
                (visibility
                  (pvt_token))
                (id
                  (word_token))
                (symbol_or_call
                  (symbol
                    (id
                      (word_token))))))
            (sep)
            (reopen
              (id
                (word_token))
              (reopen_token)
              (block
                (reopen
                  (id
                    (word_token))
                  (reopen_token)
                  (block
                    (compound_assignment
                      (id
                        (word_token))
                      (compound_op
                        (plus_equal_token))
                      (select_or_call
                        (symbol_or_call
                          (symbol
                            (id
                              (word_token))))
                        (dot_token)
                        (id
                          (word_token))))))))
            (sep))))
      (sep)
      (slot
        (type_and_args_and_block_slot
          (visibility
            (pub_token))
          (id
            (word_token))
          (arg_types
            (arg_type
              (arg_with_type
                (id
                  (word_token))
                (colon_token)
                (type
                  (non_null
                    (type
                      (list_type
                        (type
                          (non_null
                            (type
                              (named_type
                                (upper_id
                                  (upper_token))))
                            (bang_token)))))
                    (bang_token))))))
          (colon_token)
          (type
            (non_null
              (type
                (named_type
                  (upper_id
                    (upper_token))))
              (bang_token)))
          (block
            (slot
              (value_only_slot
                (visibility
                  (pvt_token))
                (id
                  (word_token))
                (symbol_or_call
                  (symbol
                    (id
                      (word_token))))))
            (sep)
            (reopen
              (id
                (word_token))
              (reopen_token)
              (block
                (reopen
                  (id
                    (word_token))
                  (reopen_token)
                  (block
                    (compound_assignment
                      (id
                        (word_token))
                      (compound_op
                        (plus_equal_token))
                      (select_or_call
                        (symbol_or_call
                          (symbol
                            (id
                              (word_token))))
                        (dot_token)
                        (id
                          (word_token))))))))
            (sep))))
      (sep)
      (slot
        (type_and_block_slot
          (visibility
            (pub_token))
          (id
            (word_token))
          (colon_token)
          (type
            (non_null
              (type
                (named_type
                  (upper_id
                    (upper_token))))
              (bang_token)))
          (block
            (select_or_call
              (symbol_or_call
                (symbol
                  (id
                    (word_token))))
              (dot_token)
              (id
                (word_token))
              (arg_values
                (argument
                  (positional_value
                    (select_or_call
                      (select_or_call
                        (select_or_call
                          (select_or_call
                            (symbol_or_call
                              (symbol
                                (id
                                  (word_token))))
                            (dot_token)
                            (id
                              (word_token))
                            (arg_values
                              (argument
                                (positional_value
                                  (literal
                                    (string))))))
                          (dot_token)
                          (id
                            (word_token))
                          (arg_values
                            (argument
                              (positional_value
                                (literal
                                  (string))))
                            (sep
                              (comma_token))
                            (argument
                              (positional_value
                                (symbol_or_call
                                  (call
                                    (id
                                      (word_token))
                                    (arg_values
                                      (argument
                                        (positional_value
                                          (literal
                                            (string)))))))))))
                        (dot_token)
                        (id
                          (word_token))
                        (arg_values
                          (argument
                            (positional_value
                              (list
                                (literal
                                  (string))
                                (sep
                                  (comma_token))
                                (literal
                                  (string))
                                (sep
                                  (comma_token))
                                (literal
                                  (string))
                                (sep
                                  (comma_token))
                                (literal
                                  (string))
                                (sep
                                  (comma_token))
                                (symbol_or_call
                                  (call
                                    (id
                                      (word_token))
                                    (arg_values
                                      (argument
                                        (positional_value
                                          (symbol_or_call
                                            (symbol
                                              (id
                                                (word_token)))))))))
                                (sep
                                  (comma_token))
                                (literal
                                  (string)))))))
                      (dot_token)
                      (id
                        (word_token))
                      (arg_values
                        (argument
                          (positional_value
                            (literal
                              (string))))))))
                (sep)))
            (sep))))
      (sep)
      (slot
        (type_and_args_and_block_slot
          (visibility
            (pub_token))
          (id
            (word_token))
          (arg_types
            (arg_type
              (arg_with_type
                (id
                  (word_token))
                (colon_token)
                (type
                  (non_null
                    (type
                      (list_type
                        (type
                          (non_null
                            (type
                              (named_type
                                (upper_id
                                  (upper_token))))
                            (bang_token)))))
                    (bang_token)))))
            (sep
              (comma_token))
            (arg_type
              (arg_with_default
                (id
                  (word_token))
                (colon_token)
                (type
                  (non_null
                    (type
                      (named_type
                        (upper_id
                          (upper_token))))
                    (bang_token)))
                (literal
                  (string)))))
          (colon_token)
          (type
            (non_null
              (type
                (named_type
                  (upper_id
                    (upper_token))))
              (bang_token)))
          (block
            (select_or_call
              (select_or_call
                (select_or_call
                  (symbol_or_call
                    (symbol
                      (id
                        (word_token))))
                  (dot_token)
                  (id
                    (word_token))
                  (arg_values
                    (argument
                      (positional_value
                        (symbol_or_call
                          (symbol
                            (id
                              (word_token))))))))
                (dot_token)
                (id
                  (word_token))
                (arg_values
                  (argument
                    (positional_value
                      (symbol_or_call
                        (symbol
                          (id
                            (word_token))))))))
              (dot_token)
              (id
                (word_token)))
            (sep))))
      (sep)))
  (sep))
