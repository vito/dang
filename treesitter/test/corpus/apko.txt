===
Apko
===

pub description =
  "Builds containers from simple lists of packages using the Apko CLI."

# TODO
pvt arch = "x86_64"

type Apko {
  pub config = {{
    contents: {{
      packages: []
      repositories: []
      keyring: []
    }}
    cmd: ""
    environment: {{
      PATH: "/usr/local/bin:/usr/bin:/bin"
    }}
    archs: [arch]
  }}

  pub withAlpine(branch: String! = "edge"): Apko! {
    self.config.contents.packages += ["apk-tools"]
    self.config.contents.repositories += [
      ("https://dl-cdn.alpinelinux.org/alpine/" + branch) + "/main"
    ]
  }

  pub withPackages(packages: [String!]!): Apko! {
    self.config.contents.packages += packages
  }

  pub withArchs(archs: [String!]!): Apko! {
    self.config.archs += archs
  }

  pub asContainer: Container! {
    container.import(
      container.
        from("cgr.dev/chainguard/apko").
        withMountedCache("/apkache/", cacheVolume("apko")).
        withNewFile("/config.yml", contents: json(config)).
        withExec(["apko", "build", "--cache-dir", "/apkache/", "/config.yml", "latest","layout.tar"]).
        file("layout.tar")
    )
  }

  pub alpine(packages: [String!]!, branch: String! = "edge"): Container! {
    withAlpine(branch).withPackages(packages).asContainer
  }
}

print(json(Apko.withAlpine.config))
print(Apko.withAlpine.withPackages(["git"]).asContainer.withExec(["git", "version"]).stdout)
print(Apko.alpine(["git"]).withExec(["git", "version"]).stdout)
---

(bind
  (slot
    (value_only_slot
      (visibility
        (pub_token))
      (id
        (word_token))
      (equal_token)
      (literal
        (string))))
  (sep)
  (comment_token)
  (slot
    (value_only_slot
      (visibility
        (pvt_token))
      (id
        (word_token))
      (equal_token)
      (literal
        (string))))
  (sep)
  (class
    (type_token)
    (id
      (word_token))
    (block
      (slot
        (value_only_slot
          (visibility
            (pub_token))
          (id
            (word_token))
          (equal_token)
          (object
            (key_value
              (word_token)
              (colon_token)
              (object
                (key_value
                  (word_token)
                  (colon_token)
                  (list))
                (sep)
                (key_value
                  (word_token)
                  (colon_token)
                  (list))
                (sep)
                (key_value
                  (word_token)
                  (colon_token)
                  (list))
                (sep)))
            (sep)
            (key_value
              (word_token)
              (colon_token)
              (literal
                (string)))
            (sep)
            (key_value
              (word_token)
              (colon_token)
              (object
                (key_value
                  (word_token)
                  (colon_token)
                  (literal
                    (string)))
                (sep)))
            (sep)
            (key_value
              (word_token)
              (colon_token)
              (list
                (symbol_or_call
                  (symbol
                    (id
                      (word_token))))))
            (sep))))
      (sep)
      (slot
        (type_and_args_and_block_slot
          (visibility
            (pub_token))
          (id
            (word_token))
          (arg_types
            (arg_type
              (arg_with_default
                (id
                  (word_token))
                (colon_token)
                (type
                  (non_null
                    (type
                      (named_type
                        (upper_id
                          (upper_token))))
                    (bang_token)))
                (equal_token)
                (literal
                  (string)))))
          (colon_token)
          (type
            (non_null
              (type
                (named_type
                  (upper_id
                    (upper_token))))
              (bang_token)))
          (block
            (reassignment
              (select_or_call
                (select_or_call
                  (select_or_call
                    (symbol_or_call
                      (symbol
                        (id
                          (word_token))))
                    (dot_token)
                    (id
                      (word_token)))
                  (dot_token)
                  (id
                    (word_token)))
                (dot_token)
                (id
                  (word_token)))
              (assign_op
                (plus_equal_token))
              (list
                (literal
                  (string))))
            (sep)
            (reassignment
              (select_or_call
                (select_or_call
                  (select_or_call
                    (symbol_or_call
                      (symbol
                        (id
                          (word_token))))
                    (dot_token)
                    (id
                      (word_token)))
                  (dot_token)
                  (id
                    (word_token)))
                (dot_token)
                (id
                  (word_token)))
              (assign_op
                (plus_equal_token))
              (list
                (default_expr
                  (equality_expr
                    (relational_expr
                      (additive_expr
                        (paren_form
                          (default_expr
                            (equality_expr
                              (relational_expr
                                (additive_expr
                                  (literal
                                    (string))
                                  (additive_op)
                                  (symbol_or_call
                                    (symbol
                                      (id
                                        (word_token)))))))))
                        (additive_op)
                        (literal
                          (string))))))
                (sep)))
            (sep))))
      (sep)
      (slot
        (type_and_args_and_block_slot
          (visibility
            (pub_token))
          (id
            (word_token))
          (arg_types
            (arg_type
              (arg_with_type
                (id
                  (word_token))
                (colon_token)
                (type
                  (non_null
                    (type
                      (list_type
                        (type
                          (non_null
                            (type
                              (named_type
                                (upper_id
                                  (upper_token))))
                            (bang_token)))))
                    (bang_token))))))
          (colon_token)
          (type
            (non_null
              (type
                (named_type
                  (upper_id
                    (upper_token))))
              (bang_token)))
          (block
            (reassignment
              (select_or_call
                (select_or_call
                  (select_or_call
                    (symbol_or_call
                      (symbol
                        (id
                          (word_token))))
                    (dot_token)
                    (id
                      (word_token)))
                  (dot_token)
                  (id
                    (word_token)))
                (dot_token)
                (id
                  (word_token)))
              (assign_op
                (plus_equal_token))
              (symbol_or_call
                (symbol
                  (id
                    (word_token)))))
            (sep))))
      (sep)
      (slot
        (type_and_args_and_block_slot
          (visibility
            (pub_token))
          (id
            (word_token))
          (arg_types
            (arg_type
              (arg_with_type
                (id
                  (word_token))
                (colon_token)
                (type
                  (non_null
                    (type
                      (list_type
                        (type
                          (non_null
                            (type
                              (named_type
                                (upper_id
                                  (upper_token))))
                            (bang_token)))))
                    (bang_token))))))
          (colon_token)
          (type
            (non_null
              (type
                (named_type
                  (upper_id
                    (upper_token))))
              (bang_token)))
          (block
            (reassignment
              (select_or_call
                (select_or_call
                  (symbol_or_call
                    (symbol
                      (id
                        (word_token))))
                  (dot_token)
                  (id
                    (word_token)))
                (dot_token)
                (id
                  (word_token)))
              (assign_op
                (plus_equal_token))
              (symbol_or_call
                (symbol
                  (id
                    (word_token)))))
            (sep))))
      (sep)
      (slot
        (type_and_block_slot
          (visibility
            (pub_token))
          (id
            (word_token))
          (colon_token)
          (type
            (non_null
              (type
                (named_type
                  (upper_id
                    (upper_token))))
              (bang_token)))
          (block
            (select_or_call
              (symbol_or_call
                (symbol
                  (id
                    (word_token))))
              (dot_token)
              (id
                (word_token))
              (arg_values
                (argument
                  (positional_value
                    (select_or_call
                      (select_or_call
                        (select_or_call
                          (select_or_call
                            (select_or_call
                              (symbol_or_call
                                (symbol
                                  (id
                                    (word_token))))
                              (dot_token)
                              (id
                                (word_token))
                              (arg_values
                                (argument
                                  (positional_value
                                    (literal
                                      (string))))))
                            (dot_token)
                            (id
                              (word_token))
                            (arg_values
                              (argument
                                (positional_value
                                  (literal
                                    (string))))
                              (sep
                                (comma_token))
                              (argument
                                (positional_value
                                  (symbol_or_call
                                    (call
                                      (id
                                        (word_token))
                                      (arg_values
                                        (argument
                                          (positional_value
                                            (literal
                                              (string)))))))))))
                          (dot_token)
                          (id
                            (word_token))
                          (arg_values
                            (argument
                              (positional_value
                                (literal
                                  (string))))
                            (sep
                              (comma_token))
                            (argument
                              (key_value
                                (word_token)
                                (colon_token)
                                (symbol_or_call
                                  (call
                                    (id
                                      (word_token))
                                    (arg_values
                                      (argument
                                        (positional_value
                                          (symbol_or_call
                                            (symbol
                                              (id
                                                (word_token)))))))))))))
                        (dot_token)
                        (id
                          (word_token))
                        (arg_values
                          (argument
                            (positional_value
                              (list
                                (literal
                                  (string))
                                (sep
                                  (comma_token))
                                (literal
                                  (string))
                                (sep
                                  (comma_token))
                                (literal
                                  (string))
                                (sep
                                  (comma_token))
                                (literal
                                  (string))
                                (sep
                                  (comma_token))
                                (literal
                                  (string))
                                (sep
                                  (comma_token))
                                (literal
                                  (string))
                                (sep
                                  (comma_token))
                                (literal
                                  (string)))))))
                      (dot_token)
                      (id
                        (word_token))
                      (arg_values
                        (argument
                          (positional_value
                            (literal
                              (string))))))))
                (sep)))
            (sep))))
      (sep)
      (slot
        (type_and_args_and_block_slot
          (visibility
            (pub_token))
          (id
            (word_token))
          (arg_types
            (arg_type
              (arg_with_type
                (id
                  (word_token))
                (colon_token)
                (type
                  (non_null
                    (type
                      (list_type
                        (type
                          (non_null
                            (type
                              (named_type
                                (upper_id
                                  (upper_token))))
                            (bang_token)))))
                    (bang_token)))))
            (sep
              (comma_token))
            (arg_type
              (arg_with_default
                (id
                  (word_token))
                (colon_token)
                (type
                  (non_null
                    (type
                      (named_type
                        (upper_id
                          (upper_token))))
                    (bang_token)))
                (equal_token)
                (literal
                  (string)))))
          (colon_token)
          (type
            (non_null
              (type
                (named_type
                  (upper_id
                    (upper_token))))
              (bang_token)))
          (block
            (select_or_call
              (select_or_call
                (symbol_or_call
                  (call
                    (id
                      (word_token))
                    (arg_values
                      (argument
                        (positional_value
                          (symbol_or_call
                            (symbol
                              (id
                                (word_token)))))))))
                (dot_token)
                (id
                  (word_token))
                (arg_values
                  (argument
                    (positional_value
                      (symbol_or_call
                        (symbol
                          (id
                            (word_token))))))))
              (dot_token)
              (id
                (word_token)))
            (sep))))
      (sep)))
  (sep)
  (symbol_or_call
    (call
      (id
        (word_token))
      (arg_values
        (argument
          (positional_value
            (symbol_or_call
              (call
                (id
                  (word_token))
                (arg_values
                  (argument
                    (positional_value
                      (select_or_call
                        (select_or_call
                          (symbol_or_call
                            (symbol
                              (id
                                (word_token))))
                          (dot_token)
                          (id
                            (word_token)))
                        (dot_token)
                        (id
                          (word_token)))))))))))))
  (sep)
  (symbol_or_call
    (call
      (id
        (word_token))
      (arg_values
        (argument
          (positional_value
            (select_or_call
              (select_or_call
                (select_or_call
                  (select_or_call
                    (select_or_call
                      (symbol_or_call
                        (symbol
                          (id
                            (word_token))))
                      (dot_token)
                      (id
                        (word_token)))
                    (dot_token)
                    (id
                      (word_token))
                    (arg_values
                      (argument
                        (positional_value
                          (list
                            (literal
                              (string)))))))
                  (dot_token)
                  (id
                    (word_token)))
                (dot_token)
                (id
                  (word_token))
                (arg_values
                  (argument
                    (positional_value
                      (list
                        (literal
                          (string))
                        (sep
                          (comma_token))
                        (literal
                          (string)))))))
              (dot_token)
              (id
                (word_token))))))))
  (sep)
  (symbol_or_call
    (call
      (id
        (word_token))
      (arg_values
        (argument
          (positional_value
            (select_or_call
              (select_or_call
                (select_or_call
                  (symbol_or_call
                    (symbol
                      (id
                        (word_token))))
                  (dot_token)
                  (id
                    (word_token))
                  (arg_values
                    (argument
                      (positional_value
                        (list
                          (literal
                            (string)))))))
                (dot_token)
                (id
                  (word_token))
                (arg_values
                  (argument
                    (positional_value
                      (list
                        (literal
                          (string))
                        (sep
                          (comma_token))
                        (literal
                          (string)))))))
              (dot_token)
              (id
                (word_token)))))))))
