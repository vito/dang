cls MyClass {
  pub val = 1
  pub name = "initial"

  pub new: MyClass! {
    self
  }

  pub incr: MyClass! {
    print("BEFORE:")
    print(self.val)
    self.val += 1
    print("AFTER:")
    print(self.val)
    self # TODO: make not required?
  }

  pub incrBy(amount: Int!): MyClass! {
    self.val += amount
    self # TODO: make not required?
  }

  pub withName(branch: String! = "edge"): MyClass! {
    self.name = branch
    self # TODO: make not required?
  }

  pub complex(prefix: String! = "pre", suffix: String! = "suf"): MyClass! {
    self.name = (prefix + "-") + suffix
    self # TODO: make not required?
  }

  pub dynamicAccess(): String! {
    name  # Should resolve to current receiver's name, not static "initial"
  }
}

assert { MyClass.new.val == 1 }
assert { MyClass.new.incr.val == 2 }
assert { MyClass.new.incr.incr.val == 3 }
assert { MyClass.new.incrBy(5).val == 6 }
assert { MyClass.new.incrBy(3).incrBy(2).val == 6 }
assert { MyClass.new.withName("test").name == "test" }
assert { MyClass.new.withName().name == "edge" }
assert { MyClass.new.complex().name == "pre-suf" }
assert { MyClass.new.complex("hello", "world").name == "hello-world" }

# Test: variables resolve against current receiver instance, not static scope
assert { MyClass.new.dynamicAccess() == "initial" }
assert { MyClass.new.withName("modified").dynamicAccess() == "modified" }
assert { MyClass.new.complex("hello", "world").dynamicAccess() == "hello-world" }
