# Test that method calls from constructors propagate changes (issue #24)

# Basic: constructor calls a method that returns a modified self
type Builder {
  pub value: String! = ""

  new(initial: String!) {
    self.value = initial
    self.withSuffix("!")
  }

  pub withSuffix(s: String!): Builder! {
    self.value = self.value + s
    self
  }
}

assert { Builder("hello").value == "hello!" }
assert { Builder("hello").withSuffix("?").value == "hello!?" }

# Method chain in the middle of a constructor
type Config {
  pub host: String!
  pub port: Int!

  new(host: String!, port: Int! = 8080) {
    self.host = host
    self.port = port
    self.withDefaults
  }

  pub withDefaults: Config! {
    self.host = self.host + ".local"
    self
  }
}

assert { Config("myapp").host == "myapp.local" }
assert { Config("myapp").port == 8080 }

# Multiple method calls in constructor
type Pipeline {
  pub steps: [String!]! = []

  new(name: String!) {
    self.steps = [name]
    self.addStep("init").addStep("ready")
  }

  pub addStep(step: String!): Pipeline! {
    self.steps = self.steps + [step]
    self
  }
}

assert { Pipeline("start").steps == ["start", "init", "ready"] }

print("Constructor method chain tests passed!")
