#!/usr/bin/env bind

let src = host.directory(
  ".",
  include: [
    "**/*.go",
    "**/go.mod",
    "**/go.sum",
    "introspection/introspection.graphql",
  ]
)

let bin(src: Directory!): File! {
  container.
    from("golang").
    withDirectory("/src", src).
    withWorkdir("/src").
    withEnvVariable("CGO_ENABLED", "0").
    withExec(["go", "build", "-o", "/out/bind", "./cmd/bind"]).
    file("/out/bind")
}

let test(bin: File!): String! {
  container.
    from("alpine").
    withFile("/bin/bind", bin).
    withExec(["bind", "--version"]).
    stdout
}

print(test(bin(src)))
